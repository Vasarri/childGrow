<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grafico di Crescita Neonat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-wrapper { position: relative; height: 450px; }
        .tab-button.active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
        .tab-button { 
            transition: background-color 0.2s, color 0.2s, border-color 0.2s; 
            border-bottom-width: 2px;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.2em;
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">Tracciatore di Crescita Completo</h1>
            <p class="mt-2 text-lg text-slate-600">Monitora peso, altezza e circonferenza cranica del tuo bambino.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Pannello di Controllo -->
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg flex flex-col">
                <div>
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Dati del Bambino</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="birthDate" class="block text-sm font-medium text-slate-700 mb-1">Data di nascita</label>
                            <input type="date" id="birthDate" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <div class="flex space-x-2 pt-2">
                             <button id="exportBtn" class="flex-1 bg-green-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-green-700 text-sm">Esporta Dati</button>
                             <button id="importBtn" class="flex-1 bg-sky-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-sky-700 text-sm">Importa Dati</button>
                             <input type="file" id="importFile" class="hidden" accept=".json">
                        </div>

                        <fieldset class="border-t pt-4">
                            <legend class="text-lg font-semibold text-slate-800 mb-3">Aggiungi Misurazione</legend>
                            <div class="space-y-3">
                                <div>
                                    <label for="measurementDate" class="block text-sm font-medium text-slate-700 mb-1">Data</label>
                                    <input type="date" id="measurementDate" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div class="grid grid-cols-3 gap-2">
                                    <div>
                                        <label for="weight" class="block text-xs font-medium text-slate-700 mb-1">Peso (kg)</label>
                                        <input type="number" id="weight" step="0.01" placeholder="es. 3.5" class="w-full p-2 border border-slate-300 rounded-lg">
                                    </div>
                                    <div>
                                        <label for="height" class="block text-xs font-medium text-slate-700 mb-1">Altezza (cm)</label>
                                        <input type="number" id="height" step="0.1" placeholder="es. 50.5" class="w-full p-2 border border-slate-300 rounded-lg">
                                    </div>
                                    <div>
                                        <label for="head" class="block text-xs font-medium text-slate-700 mb-1">Testa (cm)</label>
                                        <input type="number" id="head" step="0.1" placeholder="es. 34.5" class="w-full p-2 border border-slate-300 rounded-lg">
                                    </div>
                                </div>
                                <button id="addMeasurementBtn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">Aggiungi</button>
                                <p id="error-message" class="text-red-500 text-sm mt-2"></p>
                            </div>
                        </fieldset>
                    </div>
                </div>

                <div class="mt-6 flex-grow flex flex-col">
                    <h3 class="text-xl font-semibold mb-3">Misurazioni Inserite</h3>
                    <div id="measurementsList" class="space-y-2 max-h-60 overflow-y-auto pr-2 flex-grow">
                         <p class="text-slate-500 text-sm">Nessuna misurazione ancora.</p>
                    </div>
                     <button id="resetBtn" class="w-full mt-4 bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 text-sm">Resetta Tutto</button>

                </div>
            </div>

            <!-- Grafici -->
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                <div class="mb-4 border-b border-slate-200">
                    <nav class="flex -mb-px space-x-1 sm:space-x-4" aria-label="Tabs">
                        <button data-target="weightChart-wrapper" class="tab-button active whitespace-nowrap py-3 px-4 font-medium text-sm border-transparent rounded-t-lg">Peso</button>
                        <button data-target="heightChart-wrapper" class="tab-button whitespace-nowrap py-3 px-4 font-medium text-sm border-transparent rounded-t-lg">Altezza</button>
                        <button data-target="headChart-wrapper" class="tab-button whitespace-nowrap py-3 px-4 font-medium text-sm border-transparent rounded-t-lg">Circonferenza Testa</button>
                        <button data-target="bmiChart-wrapper" class="tab-button whitespace-nowrap py-3 px-4 font-medium text-sm border-transparent rounded-t-lg">BMI</button>
                    </nav>
                </div>
                <!-- Contenitore dei grafici -->
                <div>
                    <div id="weightChart-wrapper" class="chart-wrapper">
                        <div class="loading">Caricamento dati percentili...</div>
                    </div>
                    <div id="heightChart-wrapper" class="chart-wrapper hidden">
                        <div class="loading">Caricamento dati percentili...</div>
                    </div>
                    <div id="headChart-wrapper" class="chart-wrapper hidden">
                        <div class="loading">Caricamento dati percentili...</div>
                    </div>
                    <div id="bmiChart-wrapper" class="chart-wrapper hidden">
                        <div class="loading">Caricamento dati percentili...</div>
                    </div>
                </div>
                 <p class="text-xs text-center text-slate-500 mt-2">✅ Plotly.js - Zoom e Pan perfetti! Rotellina per zoom. Trascina per spostare. Doppio clic per resettare. Selezione area per zoom.</p>
            </div>
        </div>
    </div>

    <script>
        // --- VARIABILI GLOBALI ---
        let percentileData = null;
        let childMeasurements = []; 
        let plots = {};

        // --- ELEMENTI DEL DOM ---
        const birthDateInput = document.getElementById('birthDate');
        const measurementDateInput = document.getElementById('measurementDate');
        const weightInput = document.getElementById('weight');
        const heightInput = document.getElementById('height');
        const headInput = document.getElementById('head');
        const addMeasurementBtn = document.getElementById('addMeasurementBtn');
        const resetBtn = document.getElementById('resetBtn');
        const errorMessage = document.getElementById('error-message');
        const measurementsList = document.getElementById('measurementsList');
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const importFile = document.getElementById('importFile');
        const tabs = document.querySelectorAll('.tab-button');
        const chartWrappers = document.querySelectorAll('.chart-wrapper');

        const today = new Date().toISOString().split('T')[0];
        birthDateInput.value = today;
        measurementDateInput.value = today;

        // --- CARICAMENTO DATI PERCENTILI ---
        async function loadPercentileData() {
            try {
                const response = await fetch('percentile_data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                percentileData = await response.json();
                
                // Verify that all required metrics are present
                const requiredMetrics = ['weight', 'length', 'headCircumference', 'BMI'];
                const missingMetrics = requiredMetrics.filter(metric => !percentileData[metric]);
                if (missingMetrics.length > 0) {
                    throw new Error(`Missing required metrics: ${missingMetrics.join(', ')}`);
                }
                
                initializePlots();
            } catch (error) {
                console.error('Errore nel caricamento dei dati percentili:', error);
                const errorMessage = 'Errore nel caricamento dei dati percentili. Verificare che il file percentile_data.json sia presente e accessibile.';
                
                document.querySelectorAll('.chart-wrapper').forEach(wrapper => {
                    wrapper.innerHTML = `<div class="loading text-red-500">${errorMessage}</div>`;
                });
            }
        }

        // --- FUNZIONI DI BASE ---
        function calculateAgeInMonths(birthDate, measurementDate) {
            const ageInMilliseconds = measurementDate.getTime() - birthDate.getTime();
            return ageInMilliseconds / (1000 * 60 * 60 * 24 * 30.4375);
        }

        function addMeasurement() {
            const birthDate = new Date(birthDateInput.value);
            const measurementDate = new Date(measurementDateInput.value);
            const weight = parseFloat(weightInput.value) || null;
            const height = parseFloat(heightInput.value) || null;
            const head = parseFloat(headInput.value) || null;

            // Calculate BMI if both weight and height are provided
            let bmi = null;
            if (weight && height && height > 0) {
                bmi = weight / Math.pow(height / 100, 2); // Convert cm to meters
            }

            if (!birthDateInput.value || !measurementDateInput.value) {
                errorMessage.textContent = 'Data di nascita e misurazione sono obbligatorie.';
                return;
            }
            if (measurementDate < birthDate) {
                errorMessage.textContent = 'La data di misurazione non può essere precedente alla nascita.';
                return;
            }
            if (!weight && !height && !head) {
                 errorMessage.textContent = 'Inserisci almeno un valore di misurazione.';
                 return;
            }
            errorMessage.textContent = '';

            const ageInMonths = calculateAgeInMonths(birthDate, measurementDate);
            
            childMeasurements.push({ age: ageInMonths, weight, height, head, bmi });
            childMeasurements.sort((a, b) => a.age - b.age);

            updateAllUI();
            
            weightInput.value = '';
            heightInput.value = '';
            headInput.value = '';
        }
        
        function updateAllUI() {
            updateMeasurementsList();
            updateAllPlots();
        }

        function updateMeasurementsList() {
            if (childMeasurements.length === 0) {
                measurementsList.innerHTML = '<p class="text-slate-500 text-sm">Nessuna misurazione ancora.</p>';
                return;
            }
            
            measurementsList.innerHTML = '';
            childMeasurements.forEach((m, index) => {
                const ageMonths = Math.floor(m.age);
                const ageDays = Math.round((m.age - ageMonths) * 30.44);
                
                const listItem = document.createElement('div');
                listItem.className = 'bg-slate-50 p-2 rounded-md text-sm';
                listItem.innerHTML = `
                    <div class="flex justify-between items-center font-semibold">
                        <span>Età: ${ageMonths}m ${ageDays}g</span>
                        <button class="text-red-500 hover:text-red-700 text-xs font-bold" onclick="deleteMeasurement(${index})">X</button>
                    </div>
                    <div class="flex justify-around text-xs mt-1 text-slate-600">
                        ${m.weight ? `<span>P: <strong>${m.weight.toFixed(2)}</strong> kg</span>` : ''}
                        ${m.height ? `<span>A: <strong>${m.height.toFixed(1)}</strong> cm</span>` : ''}
                        ${m.head ? `<span>T: <strong>${m.head.toFixed(1)}</strong> cm</span>` : ''}
                        ${m.bmi ? `<span>BMI: <strong>${m.bmi.toFixed(2)}</strong></span>` : ''}
                    </div>`;
                measurementsList.appendChild(listItem);
            });
        }
        
        function deleteMeasurement(index) {
            childMeasurements.splice(index, 1);
            updateAllUI();
        }

        function resetData() {
            if (confirm("Sei sicuro di voler cancellare tutti i dati? L'azione è irreversibile.")) {
                childMeasurements = [];
                birthDateInput.value = today;
                measurementDateInput.value = today;
                updateAllUI();
            }
        }

        // --- GESTIONE GRAFICI PLOTLY ---
        function createPlot(wrapperId, metric, unit, minY) {
            const wrapper = document.getElementById(wrapperId);
            wrapper.innerHTML = `<div id="${wrapperId.replace('-wrapper', '')}"></div>`;
            
            const metricDataSource = percentileData[metric];
            
            if (!metricDataSource) {
                console.error(`No data found for metric: ${metric}`);
                wrapper.innerHTML = `<div class="loading text-red-500">Errore: Dati non trovati per ${metric}</div>`;
                return;
            }

            const createPercentileTrace = (percentileKey, label, color, isDashed) => {
                const percentileValues = metricDataSource[percentileKey];
                if (!percentileValues) {
                    console.error(`Percentile key ${percentileKey} not found for metric ${metric}`);
                    return null;
                }
                
                return {
                    x: percentileData.months,
                    y: percentileValues,
                    type: 'scatter',
                    mode: 'lines',
                    name: label,
                    line: {
                        color: color,
                        dash: isDashed ? 'dash' : 'solid',
                        width: label === '50°' ? 3 : 2
                    },
                    showlegend: true,
                    hoverinfo: 'x+y+name'
                };
            };

            const traces = [
                createPercentileTrace('p3', '3°', 'rgba(255, 99, 132, 0.8)', true),
                createPercentileTrace('p15', '15°', 'rgba(255, 159, 64, 0.8)', true),
                createPercentileTrace('p50', '50°', 'rgba(75, 192, 192, 1)', false),
                createPercentileTrace('p85', '85°', 'rgba(54, 162, 235, 0.8)', true),
                createPercentileTrace('p97', '97°', 'rgba(153, 102, 255, 0.8)', true),
                {
                    x: [],
                    y: [],
                    type: 'scatter',
                    mode: 'markers+lines',
                    name: 'Tuo bambino',
                    line: {
                        color: 'rgba(79, 70, 229, 1)',
                        width: 3
                    },
                    marker: {
                        size: 8,
                        color: 'rgba(79, 70, 229, 1)'
                    },
                    showlegend: true,
                    hoverinfo: 'x+y+name'
                }
            ].filter(trace => trace !== null);

            const chartTitle = metric === 'BMI' ? 'Indice di Massa Corporea (0-60 Mesi)' : 
                      metric === 'length' ? 'Curva di Crescita - Altezza (0-60 Mesi)' :
                      metric === 'headCircumference' ? 'Curva di Crescita - Circonferenza Cranica (0-60 Mesi)' :
                      `Curva di Crescita - ${metric.charAt(0).toUpperCase() + metric.slice(1)} (0-60 Mesi)`;

            const layout = {
                title: chartTitle,
                xaxis: {
                    title: 'Età (Mesi)',
                    range: [0, 60],
                    dtick: 5
                },
                yaxis: {
                    title: `${metric === 'length' ? 'Altezza' : metric === 'headCircumference' ? 'Circonferenza Cranica' : metric.charAt(0).toUpperCase() + metric.slice(1)} (${unit})`,
                    range: [minY, null]
                },
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: -0.2
                },
                margin: { l: 60, r: 30, t: 60, b: 80 },
                hovermode: 'closest',
                // Plotly zoom and pan settings
                dragmode: 'pan',
                modebar: {
                    orientation: 'v',
                    bgcolor: 'rgba(255,255,255,0.8)',
                    color: 'rgba(0,0,0,0.5)',
                    activecolor: 'rgba(0,0,0,0.7)'
                },
                // Add year indicator lines
                shapes: [
                    // 1 year line (12 months)
                    {
                        type: 'line',
                        x0: 12,
                        x1: 12,
                        y0: 0,
                        y1: 1,
                        yref: 'paper',
                        line: {
                            color: 'rgba(0, 0, 0, 0.3)',
                            width: 1,
                            dash: 'dot'
                        }
                    },
                    // 2 years line (24 months)
                    {
                        type: 'line',
                        x0: 24,
                        x1: 24,
                        y0: 0,
                        y1: 1,
                        yref: 'paper',
                        line: {
                            color: 'rgba(0, 0, 0, 0.3)',
                            width: 1,
                            dash: 'dot'
                        }
                    },
                    // 3 years line (36 months)
                    {
                        type: 'line',
                        x0: 36,
                        x1: 36,
                        y0: 0,
                        y1: 1,
                        yref: 'paper',
                        line: {
                            color: 'rgba(0, 0, 0, 0.3)',
                            width: 1,
                            dash: 'dot'
                        }
                    },
                    // 4 years line (48 months)
                    {
                        type: 'line',
                        x0: 48,
                        x1: 48,
                        y0: 0,
                        y1: 1,
                        yref: 'paper',
                        line: {
                            color: 'rgba(0, 0, 0, 0.3)',
                            width: 1,
                            dash: 'dot'
                        }
                    },
                    // 5 years line (60 months)
                    {
                        type: 'line',
                        x0: 60,
                        x1: 60,
                        y0: 0,
                        y1: 1,
                        yref: 'paper',
                        line: {
                            color: 'rgba(0, 0, 0, 0.3)',
                            width: 1,
                            dash: 'dot'
                        }
                    }
                ],
                // Add year annotations
                annotations: [
                    {
                        x: 12,
                        y: 1.02,
                        yref: 'paper',
                        text: '1 anno',
                        showarrow: false,
                        font: {
                            size: 10,
                            color: 'rgba(0, 0, 0, 0.6)'
                        }
                    },
                    {
                        x: 24,
                        y: 1.02,
                        yref: 'paper',
                        text: '2 anni',
                        showarrow: false,
                        font: {
                            size: 10,
                            color: 'rgba(0, 0, 0, 0.6)'
                        }
                    },
                    {
                        x: 36,
                        y: 1.02,
                        yref: 'paper',
                        text: '3 anni',
                        showarrow: false,
                        font: {
                            size: 10,
                            color: 'rgba(0, 0, 0, 0.6)'
                        }
                    },
                    {
                        x: 48,
                        y: 1.02,
                        yref: 'paper',
                        text: '4 anni',
                        showarrow: false,
                        font: {
                            size: 10,
                            color: 'rgba(0, 0, 0, 0.6)'
                        }
                    },
                    {
                        x: 60,
                        y: 1.02,
                        yref: 'paper',
                        text: '5 anni',
                        showarrow: false,
                        font: {
                            size: 10,
                            color: 'rgba(0, 0, 0, 0.6)'
                        }
                    }
                ]
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToAdd: [
                    'pan2d',
                    'select2d',
                    'lasso2d',
                    'resetScale2d'
                ],
                modeBarButtonsToRemove: ['autoScale2d']
            };

            Plotly.newPlot(wrapperId.replace('-wrapper', ''), traces, layout, config);
            

        }

        function updateAllPlots() {
            // Update each plot
            const plotIds = ['weightChart', 'heightChart', 'headChart', 'bmiChart'];
            
            plotIds.forEach(plotId => {
                const plotDiv = document.getElementById(plotId);
                if (!plotDiv) return;
                
                let childData = [];
                
                if (plotId === 'bmiChart') {
                    // Calculate BMI from weight and height data
                    childData = childMeasurements
                        .filter(m => m.weight != null && m.height != null && m.height > 0)
                        .map(m => {
                            const bmi = m.weight / Math.pow(m.height / 100, 2);
                            return { x: m.age, y: bmi };
                        });
                } else {
                    // Map the correct property names
                    let propertyName = plotId.replace('Chart', '');
                    if (plotId === 'heightChart') propertyName = 'height';
                    if (plotId === 'headChart') propertyName = 'head';
                    
                    childData = childMeasurements
                        .filter(m => m[propertyName] != null)
                        .map(m => ({ x: m.age, y: m[propertyName] }));
                }
                
                // Update the child data trace (6th trace, index 5)
                Plotly.restyle(plotDiv, {
                    x: [childData.map(d => d.x)],
                    y: [childData.map(d => d.y)]
                }, [5]);
            });
        }

        // --- GESTIONE TAB ---
        tabs.forEach(tab => {
            tab.addEventListener('click', (event) => {
                tabs.forEach(t => t.classList.remove('active'));
                event.currentTarget.classList.add('active');
                
                const targetId = event.currentTarget.dataset.target;
                
                chartWrappers.forEach(wrapper => {
                    if (wrapper.id === targetId) {
                        wrapper.classList.remove('hidden');
                    } else {
                        wrapper.classList.add('hidden');
                    }
                });
            });
        });

        // --- FUNZIONI IMPORT/EXPORT ---
        function exportData() {
            if (childMeasurements.length === 0) {
                alert("Nessun dato da esportare.");
                return;
            }
            const dataToSave = {
                birthDate: birthDateInput.value,
                measurements: childMeasurements
            };
            const dataStr = JSON.stringify(dataToSave, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `dati_crescita_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.birthDate && Array.isArray(data.measurements)) {
                        if (childMeasurements.length > 0 && !confirm("Importando un nuovo file, i dati attuali verranno sovrascritti. Continuare?")) {
                            return;
                        }
                        birthDateInput.value = data.birthDate;
                        childMeasurements = data.measurements;
                        childMeasurements.sort((a, b) => a.age - b.age);
                        updateAllUI();
                    } else {
                        alert("File JSON non valido o malformato.");
                    }
                } catch (error) {
                    alert("Errore durante la lettura del file JSON.");
                    console.error(error);
                }
            };
            reader.readAsText(file);
            importFile.value = '';
        }
        
        // --- INIZIALIZZAZIONE ---
        window.onload = () => {
            loadPercentileData();

            addMeasurementBtn.addEventListener('click', addMeasurement);
            resetBtn.addEventListener('click', resetData);
            exportBtn.addEventListener('click', exportData);
            importBtn.addEventListener('click', () => importFile.click());
            importFile.addEventListener('change', importData);
            
            updateAllUI();
        };

        // --- FUNZIONE DI INIZIALIZZAZIONE GRAFICI ---
        function initializePlots() {
            if (!percentileData) {
                console.error('Dati percentili non disponibili');
                return;
            }
            
            try {
                createPlot('weightChart-wrapper', 'weight', 'kg', 2);
                createPlot('heightChart-wrapper', 'length', 'cm', 45);
                createPlot('headChart-wrapper', 'headCircumference', 'cm', 32);
                createPlot('bmiChart-wrapper', 'BMI', '', 11);
                
                // Store plot references
                plots = {
                    'weightChart': document.getElementById('weightChart'),
                    'heightChart': document.getElementById('heightChart'),
                    'headChart': document.getElementById('headChart'),
                    'bmiChart': document.getElementById('bmiChart')
                };
                
                updateAllPlots();
            } catch (error) {
                console.error('Errore durante l\'inizializzazione dei grafici:', error);
            }
        }
    </script>
</body>
</html> 