<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grafico di Crescita Neonato (Avanzato)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Aggiunto plugin per lo zoom -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-wrapper { position: relative; height: 450px; }
        /* Stile per il tab attivo */
        .tab-button.active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
        .tab-button { 
            transition: background-color 0.2s, color 0.2s, border-color 0.2s; 
            border-bottom-width: 2px;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">Tracciatore di Crescita Completo</h1>
            <p class="mt-2 text-lg text-slate-600">Monitora peso, altezza e circonferenza cranica del tuo bambino.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Pannello di Controllo -->
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg flex flex-col">
                <div>
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Dati del Bambino</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="birthDate" class="block text-sm font-medium text-slate-700 mb-1">Data di nascita</label>
                            <input type="date" id="birthDate" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <div class="flex space-x-2 pt-2">
                             <button id="exportBtn" class="flex-1 bg-green-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-green-700 text-sm">Esporta Dati</button>
                             <button id="importBtn" class="flex-1 bg-sky-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-sky-700 text-sm">Importa Dati</button>
                             <input type="file" id="importFile" class="hidden" accept=".json">
                        </div>

                        <fieldset class="border-t pt-4">
                            <legend class="text-lg font-semibold text-slate-800 mb-3">Aggiungi Misurazione</legend>
                            <div class="space-y-3">
                                <div>
                                    <label for="measurementDate" class="block text-sm font-medium text-slate-700 mb-1">Data</label>
                                    <input type="date" id="measurementDate" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div class="grid grid-cols-3 gap-2">
                                    <div>
                                        <label for="weight" class="block text-xs font-medium text-slate-700 mb-1">Peso (kg)</label>
                                        <input type="number" id="weight" step="0.01" placeholder="es. 3.5" class="w-full p-2 border border-slate-300 rounded-lg">
                                    </div>
                                    <div>
                                        <label for="height" class="block text-xs font-medium text-slate-700 mb-1">Altezza (cm)</label>
                                        <input type="number" id="height" step="0.1" placeholder="es. 50.5" class="w-full p-2 border border-slate-300 rounded-lg">
                                    </div>
                                    <div>
                                        <label for="head" class="block text-xs font-medium text-slate-700 mb-1">Testa (cm)</label>
                                        <input type="number" id="head" step="0.1" placeholder="es. 34.5" class="w-full p-2 border border-slate-300 rounded-lg">
                                    </div>
                                </div>
                                <button id="addMeasurementBtn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">Aggiungi</button>
                                <p id="error-message" class="text-red-500 text-sm mt-2"></p>
                            </div>
                        </fieldset>
                    </div>
                </div>

                <div class="mt-6 flex-grow flex flex-col">
                    <h3 class="text-xl font-semibold mb-3">Misurazioni Inserite</h3>
                    <div id="measurementsList" class="space-y-2 max-h-60 overflow-y-auto pr-2 flex-grow">
                         <p class="text-slate-500 text-sm">Nessuna misurazione ancora.</p>
                    </div>
                     <button id="resetBtn" class="w-full mt-4 bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 text-sm">Resetta Tutto</button>
                </div>
            </div>

            <!-- Grafici -->
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                <div class="mb-4 border-b border-slate-200">
                    <nav class="flex -mb-px space-x-1 sm:space-x-4" aria-label="Tabs">
                        <button data-target="weightChart-wrapper" class="tab-button active whitespace-nowrap py-3 px-4 font-medium text-sm border-transparent rounded-t-lg">Peso</button>
                        <button data-target="heightChart-wrapper" class="tab-button whitespace-nowrap py-3 px-4 font-medium text-sm border-transparent rounded-t-lg">Altezza</button>
                        <button data-target="headChart-wrapper" class="tab-button whitespace-nowrap py-3 px-4 font-medium text-sm border-transparent rounded-t-lg">Circonferenza Testa</button>
                    </nav>
                </div>
                <!-- Contenitore dei grafici -->
                <div>
                    <div id="weightChart-wrapper" class="chart-wrapper">
                        <canvas id="weightChart"></canvas>
                    </div>
                    <div id="heightChart-wrapper" class="chart-wrapper hidden">
                        <canvas id="heightChart"></canvas>
                    </div>
                    <div id="headChart-wrapper" class="chart-wrapper hidden">
                        <canvas id="headChart"></canvas>
                    </div>
                </div>
                 <p class="text-xs text-center text-slate-500 mt-2">Usa la rotellina del mouse o il "pinch-to-zoom" per ingrandire. Fai doppio clic per resettare lo zoom.</p>
            </div>
        </div>
    </div>

    <script>
        // --- DATI PERCENTILI OMS (MASCHI, 0-12 MESI) ---
        const percentileData = {
            months: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24],
            weight: {
                p3: [2.5, 3.4, 4.4, 5.1, 5.6, 6.1, 6.4, 6.7, 7.0, 7.2, 7.4, 7.6, 7.8], 
                p15: [2.9, 3.9, 5.0, 5.8, 6.4, 6.9, 7.3, 7.6, 7.9, 8.2, 8.4, 8.6, 8.8], 
                p50: [3.3, 4.5, 5.6, 6.4, 7.0, 7.5, 7.9, 8.3, 8.6, 8.9, 9.2, 9.4, 9.7], 
                p85: [3.9, 5.1, 6.3, 7.2, 7.8, 8.4, 8.8, 9.2, 9.6, 9.9, 10.2, 10.5, 10.8], 
                p97: [4.3, 5.6, 6.9, 7.9, 8.6, 9.2, 9.7, 10.1, 10.5, 10.9, 11.2, 11.5, 11.8] },
            
            length: {
                p3: [46.3, 51.1, 54.7, 57.6, 60, 61.9, 63.6, 65.1, 66.5, 67.7, 69, 70.2, 71.3, 72.4, 73.4, 74.4, 75.4, 76.3, 77.2, 78.1, 78.9, 79.7, 80.5, 81.3, 82.1],
                p15: [47.9, 52.7, 56.4, 59.3, 61.7, 63.7, 65.4, 66.9, 68.3, 69.6, 70.9, 72.1, 73.3, 74.4, 75.5, 76.5, 77.5, 78.5, 79.5, 80.4, 81.3, 82.2, 83, 83.8, 84.6],
                p50: [49.9, 54.7, 58.4, 61.4, 63.9, 65.9, 67.6, 69.2, 70.6, 72, 73.3, 74.5, 75.7, 76.9, 78, 79.1, 80.2, 81.2, 82.3, 83.2, 84.2, 85.1, 86, 86.9, 87.8],
                p85: [51.8, 56.7, 60.5, 63.5, 66, 68.1, 69.8, 71.4, 72.9, 74.3, 75.6, 77, 78.2, 79.4, 80.6, 81.8, 82.9, 84, 85.1, 86.1, 87.1, 88.1, 89.1, 90, 91],
                p97: [53.4, 58.4, 62.2, 65.3, 67.8, 69.9, 71.6, 73.2, 74.7, 76.2, 77.6, 78.9, 80.2, 81.5, 82.7, 83.9, 85.1, 86.2, 87.3, 88.4, 89.5, 90.5, 91.6, 92.6, 93.6] },

            headCircumference: {
                p3: [32.1, 32.9, 33.7, 34.3, 34.9, 35.4, 35.9, 36.3, 36.7, 37, 37.4, 37.7, 38, 38.3],
                p10: [32.8, 33.6, 34.4, 35, 35.6, 36.1, 36.6, 37, 37.4, 37.7, 38.1, 38.4, 38.7, 39],
                p50: [34.5, 35.2, 35.9, 36.5, 37.1, 37.6, 38.1, 38.5, 38.9, 39.2, 39.6, 39.9, 40.2, 40.5],
                p85: [35.8, 36.4, 37.1, 37.7, 38.3, 38.8, 39.3, 39.7, 40.1, 40.5, 40.8, 41.1, 41.4, 41.7],
                p97: [36.9, 37.5, 38.1, 38.7, 39.3, 39.8, 40.3, 40.7, 41.1, 41.4, 41.8, 42.1, 42.4, 42.7] },
                
            BMI: {
                p3: [11.3, 11, 11.3, 11.9, 12.4, 12.8, 13.2, 13.5, 13.7, 13.9, 14.1, 14.2, 14.3, 14.4],
                p15: [12.2, 12, 12.3, 12.9, 13.4, 13.9, 14.2, 14.5, 14.8, 15, 15.1, 15.3, 15.4, 15.5],
                p50: [13.4, 13.3, 13.6, 14.2, 14.8, 15.2, 15.6, 15.9, 16.2, 16.4, 16.5, 16.7, 16.8, 16.9],
                p85: [14.8, 14.7, 15, 15.6, 16.2, 16.7, 17.1, 17.4, 17.7, 17.9, 18.1, 18.2, 18.4, 18.4],
                p97: [16.1, 15.9, 16.2, 16.8, 17.4, 18, 18.4, 18.7, 19, 19.3, 19.4, 19.6, 19.7, 19.8] }
            };

        // --- ELEMENTI DEL DOM ---
        const birthDateInput = document.getElementById('birthDate');
        const measurementDateInput = document.getElementById('measurementDate');
        const weightInput = document.getElementById('weight');
        const heightInput = document.getElementById('height');
        const headInput = document.getElementById('head');
        const addMeasurementBtn = document.getElementById('addMeasurementBtn');
        const resetBtn = document.getElementById('resetBtn');
        const errorMessage = document.getElementById('error-message');
        const measurementsList = document.getElementById('measurementsList');
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const importFile = document.getElementById('importFile');
        const tabs = document.querySelectorAll('.tab-button');
        const chartWrappers = document.querySelectorAll('.chart-wrapper');

        const today = new Date().toISOString().split('T')[0];
        birthDateInput.value = today;
        measurementDateInput.value = today;

        let childMeasurements = []; 
        let charts = {};

        // --- FUNZIONI DI BASE ---
        function calculateAgeInMonths(birthDate, measurementDate) {
            const ageInMilliseconds = measurementDate.getTime() - birthDate.getTime();
            return ageInMilliseconds / (1000 * 60 * 60 * 24 * 30.4375);
        }

        function addMeasurement() {
            const birthDate = new Date(birthDateInput.value);
            const measurementDate = new Date(measurementDateInput.value);
            const weight = parseFloat(weightInput.value) || null;
            const height = parseFloat(heightInput.value) || null;
            const head = parseFloat(headInput.value) || null;

            if (!birthDateInput.value || !measurementDateInput.value) {
                errorMessage.textContent = 'Data di nascita e misurazione sono obbligatorie.';
                return;
            }
            if (measurementDate < birthDate) {
                errorMessage.textContent = 'La data di misurazione non può essere precedente alla nascita.';
                return;
            }
            if (!weight && !height && !head) {
                 errorMessage.textContent = 'Inserisci almeno un valore di misurazione.';
                 return;
            }
            errorMessage.textContent = '';

            const ageInMonths = calculateAgeInMonths(birthDate, measurementDate);
            
            childMeasurements.push({ age: ageInMonths, weight, height, head });
            childMeasurements.sort((a, b) => a.age - b.age);

            updateAllUI();
            
            weightInput.value = '';
            heightInput.value = '';
            headInput.value = '';
        }
        
        function updateAllUI() {
            updateMeasurementsList();
            updateAllCharts();
        }

        function updateMeasurementsList() {
            if (childMeasurements.length === 0) {
                measurementsList.innerHTML = '<p class="text-slate-500 text-sm">Nessuna misurazione ancora.</p>';
                return;
            }
            
            measurementsList.innerHTML = '';
            childMeasurements.forEach((m, index) => {
                const ageMonths = Math.floor(m.age);
                const ageDays = Math.round((m.age - ageMonths) * 30.44);
                
                const listItem = document.createElement('div');
                listItem.className = 'bg-slate-50 p-2 rounded-md text-sm';
                listItem.innerHTML = `
                    <div class="flex justify-between items-center font-semibold">
                        <span>Età: ${ageMonths}m ${ageDays}g</span>
                        <button class="text-red-500 hover:text-red-700 text-xs font-bold" onclick="deleteMeasurement(${index})">X</button>
                    </div>
                    <div class="flex justify-around text-xs mt-1 text-slate-600">
                        ${m.weight ? `<span>P: <strong>${m.weight.toFixed(2)}</strong> kg</span>` : ''}
                        ${m.height ? `<span>A: <strong>${m.height.toFixed(1)}</strong> cm</span>` : ''}
                        ${m.head ? `<span>T: <strong>${m.head.toFixed(1)}</strong> cm</span>` : ''}
                    </div>`;
                measurementsList.appendChild(listItem);
            });
        }
        
        function deleteMeasurement(index) {
            childMeasurements.splice(index, 1);
            updateAllUI();
        }

        function resetData() {
            if (confirm("Sei sicuro di voler cancellare tutti i dati? L'azione è irreversibile.")) {
                childMeasurements = [];
                birthDateInput.value = today;
                measurementDateInput.value = today;
                updateAllUI();
            }
        }

        // --- GESTIONE GRAFICI ---
        function createChart(canvasId, metric, unit, minY) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const metricDataSource = percentileData[metric];

            const createPercentileDataset = (percentileKey, label, color, isDashed) => {
                const percentileValues = metricDataSource[percentileKey];
                const dataPoints = percentileData.months.map((month, index) => ({ x: month, y: percentileValues[index] }));
                return {
                    label: label, data: dataPoints, borderColor: color,
                    borderDash: isDashed ? [5, 5] : [],
                    borderWidth: label === '50°' ? 3 : 2,
                    pointRadius: 0, fill: false, tension: 0.4
                };
            };

            const allDatasets = [
                createPercentileDataset('p3', '3°', 'rgba(255, 99, 132, 0.5)', true),
                createPercentileDataset('p15', '15°', 'rgba(255, 159, 64, 0.5)', true),
                createPercentileDataset('p50', '50°', 'rgba(75, 192, 192, 1)', false),
                createPercentileDataset('p85', '85°', 'rgba(54, 162, 235, 0.5)', true),
                createPercentileDataset('p97', '97°', 'rgba(153, 102, 255, 0.5)', true),
                {
                    label: 'Tuo bambino', data: [], borderColor: 'rgba(79, 70, 229, 1)',
                    backgroundColor: 'rgba(79, 70, 229, 1)', borderWidth: 3,
                    pointRadius: 5, fill: false, tension: 0.1
                }
            ];

            charts[metric] = new Chart(ctx, {
                type: 'line',
                data: { datasets: allDatasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onHover: (event, chartElement) => {
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                    },
                    plugins: { 
                        title: { display: true, text: `Curva di Crescita - ${metric.charAt(0).toUpperCase() + metric.slice(1)} (0-12 Mesi)`, font: { size: 16 } },
                        legend: { position: 'bottom', labels: { boxWidth: 12, padding: 20 } },
                        // --- CONFIGURAZIONE ZOOM CORRETTA ---
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'xy', // Permette il pan su entrambi gli assi
                                threshold: 5, // Numero di pixel prima che il pan inizi
                            },
                            zoom: {
                                wheel: { enabled: true },
                                pinch: { enabled: true },
                                mode: 'xy',
                            }
                        }
                    },
                    scales: {
                        x: { type: 'linear', title: { display: true, text: 'Età (Mesi)' }, min: 0, max: 12, ticks: { stepSize: 1 } },
                        y: { type: 'linear', title: { display: true, text: `${metric.charAt(0).toUpperCase() + metric.slice(1)} (${unit})` }, min: minY }
                    }
                }
            });
            // Aggiunge la funzione di reset con doppio clic
            ctx.canvas.ondblclick = () => charts[metric].resetZoom();
        }

        function updateAllCharts() {
            Object.keys(charts).forEach(metric => {
                const chart = charts[metric];
                const childDataset = chart.data.datasets.find(ds => ds.label === 'Tuo bambino');
                childDataset.data = childMeasurements
                    .filter(m => m[metric] != null)
                    .map(m => ({ x: m.age, y: m[metric] }));
                chart.update();
            });
        }

        // --- GESTIONE TAB ---
        tabs.forEach(tab => {
            tab.addEventListener('click', (event) => {
                tabs.forEach(t => t.classList.remove('active'));
                event.currentTarget.classList.add('active');
                
                const targetId = event.currentTarget.dataset.target;
                
                chartWrappers.forEach(wrapper => {
                    if (wrapper.id === targetId) {
                        wrapper.classList.remove('hidden');
                    } else {
                        wrapper.classList.add('hidden');
                    }
                });
            });
        });

        // --- FUNZIONI IMPORT/EXPORT ---
        function exportData() {
            if (childMeasurements.length === 0) {
                alert("Nessun dato da esportare.");
                return;
            }
            const dataToSave = {
                birthDate: birthDateInput.value,
                measurements: childMeasurements
            };
            const dataStr = JSON.stringify(dataToSave, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `dati_crescita_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.birthDate && Array.isArray(data.measurements)) {
                        if (childMeasurements.length > 0 && !confirm("Importando un nuovo file, i dati attuali verranno sovrascritti. Continuare?")) {
                            return;
                        }
                        birthDateInput.value = data.birthDate;
                        childMeasurements = data.measurements;
                        childMeasurements.sort((a, b) => a.age - b.age);
                        updateAllUI();
                    } else {
                        alert("File JSON non valido o malformato.");
                    }
                } catch (error) {
                    alert("Errore durante la lettura del file JSON.");
                    console.error(error);
                }
            };
            reader.readAsText(file);
            importFile.value = '';
        }
        
        // --- INIZIALIZZAZIONE ---
        window.onload = () => {
            Chart.register(window.ChartZoom);

            createChart('weightChart', 'weight', 'kg', 2);
            createChart('heightChart', 'height', 'cm', 45);
            createChart('headChart', 'head', 'cm', 30);
            createChart('bmiChart', 'bmi', 'kg/m^2', 30);

            addMeasurementBtn.addEventListener('click', addMeasurement);
            resetBtn.addEventListener('click', resetData);
            exportBtn.addEventListener('click', exportData);
            importBtn.addEventListener('click', () => importFile.click());
            importFile.addEventListener('change', importData);
            
            updateAllUI();
        };
    </script>
</body>
</html>
